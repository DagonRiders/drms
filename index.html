<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" href="css.css" />
	<script src="webdis.js"></script>
	<script src="utils.js"></script>
	<script src="querystring.js"></script>
	<script src="conf.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script>
		// Store the current state of the system
		var sensors = [];
		var switches = [];
		var states = [];

		// Toggles a switch on a particular pack
		function toggle(togglePack, toggleSwitch)
		{
			console.log("Toggling pack " + togglePack + " switch " + toggleSwitch);
			states[togglePack] = SetSwitch(
				states[togglePack], 
				toggleSwitch, 
				ReadSwitch(states[togglePack], toggleSwitch) == true ? false : true
			);
			publishValue(server, "state." + togglePack, states[togglePack]);
		}

		// Function to set up the page
		function init()
		{
			console.log("Loading...");

			subscribeValue(server, "sensors", function (value) {
				// unsubscribe for any existing subscriptions we've made
				sensors.forEach(function (sensor) { unsubscribeValue(sensor); });
				$('#test').html();

				sensors = JSON.parse(value);

				sensors.forEach(function (sensor)
				{
					$('#test').append("<div class='sensor' id='s" + sensor.sensorID + "'></div>");

					subscribeValue(server, "sensor." + sensor.sensorID, function (value) {
						$("#s" + sensor.sensorID).text(sensor.name + ": " + parseFloat(value).toFixed(1) + "Â°" + sensor.unit); 
					});
				});
			});

			subscribeValue(server, "switches", function (value) {
				switches = JSON.parse(value);
				switches.forEach(function (item)
				{
					if (!item.enabled) { return; }
					var switchDiv = $("<div class='switch' id='pack" + item.packID + "switch" + item.swID + "'>" + item.name + "</div>")
					switchDiv.on("click", function ()
					{
						toggle(item.packID, item.swID);
					});
					$('#switches').append(switchDiv);
				});
			});

			subscribeValue(server, "packs", function (value) {
				packs = JSON.parse(value);
				packs.forEach(function (pack)
				{
					subscribeValue(server, "state." + pack.packID, function (value) {
						states[pack.packID] = value;

						switches.forEach(function (item)
						{
							if (!item.enabled) { return; }
							$("#pack" + item.packID + "switch" + item.swID).removeClass("active");
							if (ReadSwitch(states[item.packID], item.swID))
							{
								$("#pack" + item.packID + "switch" + item.swID).addClass("active");
							}
						});
					});
				});
			});
		}
	</script>
</head>
<body onload="init();">
	<h1>DRMS</h1>
	<h2>Sensors</h2>
	<div id="test"></div>
	<h2>Switches</h2>
	<div id="switches"></div>
</body>
</html>