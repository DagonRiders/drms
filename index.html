<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
<style>
	BODY
	{
		background: black;
		color: #bcf;
		font-size: 20px;
		font-family: Calibri, sans-serif;
	}
	h1
	{
		font-size: 50px;
		line-height: 1;
		margin: 0;
	}
	h2
	{
		margin: 0;
		margin-top: .5em;
	}
	#switches
	{
		display: flex;
		flex-wrap: wrap;
		width: 100%;
	}
	.switch
	{
		padding: 1em;
		border: 1px solid rgba(220, 240, 255, 0.2);
		margin: 1em 1em 0em 0;
		max-width: 300px;
		min-width: 300px;
		text-align: center;
	}
	.active
	{
		background: rgba(220, 240, 255, 1);
		color: black;
	}
</style>
<script src="webdis.js"></script>
<script src="utils.js"></script>
<script src="querystring.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script>
	var server = {
		"address": "80.229.172.125:7379",
		"username": "drmsweb",
		"password": "06ded64a4a4b8051d350"
	};

	var sensors = [];
	var switches = [];
	var states = [];

	var toggleSwitch = getParameterByName("switch");
	var togglePack = getParameterByName("pack");
	var blackout = getParameterByName("blackout");
	var toggled = false;

	function toggle(togglePack, toggleSwitch)
	{
		console.log("Toggling pack " + togglePack + " switch " + toggleSwitch);
		states[togglePack] = SetSwitch(
			states[togglePack], 
			toggleSwitch, 
			ReadSwitch(states[togglePack], toggleSwitch) == true ? false : true
		);
		publishValue(server, "state." + togglePack, states[togglePack]);
	}

	function init()
	{
		console.log("Loading...");
		subscribeValue(server, "sensors", function (value) {
			// unSubscribe existing sensors
			sensors.forEach(function (sensor) { unsubscribeValue(sensor); });
			$('#test').html();

			sensors = JSON.parse(value);

			sensors.forEach(function (sensor)
			{
				$('#test').append("<div class='sensor' id='s" + sensor.sensorID + "'></div>");

				subscribeValue(server, "sensor." + sensor.sensorID, function (value) {
					$("#s" + sensor.sensorID).text(sensor.name + ": " + parseFloat(value).toFixed(1) + "Â°" + sensor.unit); 
				});
			});
		});

		subscribeValue(server, "switches", function (value) {
			switches = JSON.parse(value);
			switches.forEach(function (item)
			{
				if (!item.enabled) { return; }
				var switchDiv = $("<div class='switch' id='pack" + item.packID + "switch" + item.swID + "'>" + item.name + "</div>")
				switchDiv.on("click", function ()
				{
					toggle(item.packID, item.swID);
				});
				$('#switches').append(switchDiv);
			});
		});

		subscribeValue(server, "packs", function (value) {
			packs = JSON.parse(value);
			packs.forEach(function (pack)
			{
				subscribeValue(server, "state." + pack.packID, function (value) {
					states[pack.packID] = value;

					switches.forEach(function (item)
					{
						if (!item.enabled) { return; }
						$("#pack" + item.packID + "switch" + item.swID).removeClass("active");
						if (ReadSwitch(states[item.packID], item.swID))
						{
							$("#pack" + item.packID + "switch" + item.swID).addClass("active");
						}
					});

					if (toggleSwitch != "" && togglePack != "" && togglePack == pack.packID && !toggled)
					{
						toggled = true;
						console.log("Setting query string value");
						toggle(togglePack, toggleSwitch);
					}
					else if (blackout != "" && !toggled)
					{
						toggled = true;
						states[blackout] = 0;
						publishValue(server, "state." + blackout, states[blackout]);
					}
				});
			});
		});
	}
</script>
</head>
<body onload="init();">
<h1>DRMS</h1>
<h2>Sensors</h2>
<div id="test"></div>
<h2>Switches</h2>
<div id="switches"></div>
</body>
</html>